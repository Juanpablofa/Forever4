<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Pedidos Forever 4 </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 10px;
            background: var(--light-gray);
            color: var(--dark-gray);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .container { 
            max-width: 100%;
            margin: 0 auto; 
            background: white; 
            padding: 15px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
        }
        
        h1, h2, h3, h4 {
            margin-top: 0;
            color: var(--dark-gray);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }
        
        h3 {
            font-size: 1.2rem;
        }
        
        h4 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0; 
            font-size: 0.9rem;
        }
        
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        
        th { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 500;
        }
        
        button { 
            padding: 8px 12px; 
            margin: 3px;
            cursor: pointer; 
            border: none; 
            border-radius: var(--border-radius); 
            font-weight: bold; 
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }
        
        .btn-secondary { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        
        .btn-danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        
        .btn-warning { 
            background-color: var(--warning-color); 
            color: white; 
        }
        
        input, select, textarea { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: var(--border-radius); 
            width: 100%; 
            font-size: 0.9rem;
        }
        
        .autocomplete { 
            position: relative; 
            display: inline-block; 
            width: 100%; 
        }
        
        .autocomplete-items { 
            position: absolute; 
            border: 1px solid #ddd; 
            border-bottom: none;
            border-top: none;
            z-index: 99; 
            width: 100%; 
            max-height: 150px; 
            overflow-y: auto; 
            background: white;
        }
        
        .autocomplete-items div { 
            padding: 8px; 
            cursor: pointer; 
            background: white; 
            border-bottom: 1px solid #eee; 
            font-size: 0.9rem;
        }
        
        .autocomplete-items div:hover { 
            background: #f1f1f1; 
        }
        
        .section { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: var(--border-radius); 
        }
        
        .total-row { 
            font-weight: bold; 
            background-color: #f9f9f9; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            overflow-y: auto;
        }
        
        .modal-content { 
            background-color: #fefefe; 
            margin: 20px auto; 
            padding: 15px; 
            border-radius: var(--border-radius); 
            width: 95%; 
            max-width: 800px; 
            box-shadow: var(--box-shadow); 
            animation: modalopen 0.3s; 
        }
        
        .close { 
            color: #aaa; 
            float: right; 
            font-size: 24px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        
        .close:hover { 
            color: black; 
        }
        
        .form-group { 
            margin-bottom: 12px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            font-size: 0.9rem;
        }
        
        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .error { 
            color: var(--danger-color); 
            font-weight: bold; 
        }
        
        .success { 
            color: var(--primary-color); 
            font-weight: bold; 
        }
        
        .text-muted { 
            color: #6c757d; 
            font-size: 0.8rem; 
        }
        
        .alert { 
            padding: 8px 12px; 
            border-radius: var(--border-radius); 
            margin-bottom: 12px; 
            font-size: 0.9rem;
        }
        
        .alert-success { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .alert-danger { 
            background-color: #f8d7da; 
            color: #721c24; 
        }
        
        .table-responsive { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        
        .button-group button {
            flex: 1 1 auto;
            min-width: 120px;
        }
        
        .mobile-hidden {
            display: none;
        }

        /* Estilos para el dashboard */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .stat-card h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .period-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
                font-size: 16px;
            }
            
            .container {
                padding: 20px;
            }
            
            table {
                font-size: 1rem;
            }
            
            button {
                padding: 10px 15px;
                font-size: 1rem;
            }
            
            input, select, textarea {
                font-size: 1rem;
            }
            
            .mobile-hidden {
                display: table-cell;
            }
            
            .modal-content {
                margin: 5% auto;
                padding: 20px;
            }
        }
        
        @keyframes modalopen {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            z-index: 1001;
            box-shadow: var(--box-shadow);
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
            display: none;
            max-width: 90%;
            text-align: center;
        }
        
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 20px; opacity: 1;}
        }
        
        @keyframes fadeout {
            from {bottom: 20px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

.date-group-header {
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.date-group-header td {
    border-top: 2px solid #ddd;
    border-bottom: 2px solid #ddd;
}

    </style>
</head>
<body>
    <div class="container">
        <h1>üè™ Sistema de Pedidos Forever</h1>
        
        <div class="button-group">
            <button onclick="openImportModal()" class="btn-secondary">üì• Importar Excel</button>
            <button type="button" class="btn-primary" onclick="generateExcel()">üì§ Exportar Excel</button>
            <button onclick="resetDatabase()" class="btn-danger">üßπ Limpiar BD (NO TOCAR) </button>
            <button onclick="showAdminModal()" class="btn-warning">‚öôÔ∏è Panel Admin</button>
            <button onclick="showDashboard()" class="btn-secondary">üìä Dashboard</button>
            <button onclick="showMainView()" class="btn-primary">üè† Inicio</button>
        </div>
        
        <!-- Secci√≥n de Dashboard -->
        <div id="dashboardSection" class="section" style="display: none;">
            <h2>üìä Dashboard de M√©tricas</h2>
            
            <div class="period-selector">
                <button onclick="updateDashboard('day')" class="btn-primary">D√≠a</button>
                <button onclick="updateDashboard('week')" class="btn-primary">Semana</button>
                <button onclick="updateDashboard('month')" class="btn-primary">Mes</button>
                <button onclick="updateDashboard('year')" class="btn-primary">A√±o</button>
                <button onclick="updateDashboard('all')" class="btn-primary">Todo</button>
            </div>
            
            <div class="date-selector" id="dateSelectorContainer" style="display: none;">
                <div id="daySelector" style="display: none;">
                    <label for="specificDay">Seleccionar d√≠a:</label>
                    <input type="date" id="specificDay" onchange="updateSpecificPeriod('day')">
                </div>
                <div id="weekSelector" style="display: none;">
                    <label for="specificWeek">Seleccionar semana:</label>
                    <input type="week" id="specificWeek" onchange="updateSpecificPeriod('week')">
                </div>
                <div id="monthSelector" style="display: none;">
                    <label for="specificMonth">Seleccionar mes:</label>
                    <input type="month" id="specificMonth" onchange="updateSpecificPeriod('month')">
                </div>
                <div id="yearSelector" style="display: none;">
                    <label for="specificYear">Seleccionar a√±o:</label>
                    <select id="specificYear" onchange="updateSpecificPeriod('year')"></select>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Ventas Totales</h3>
                    <div class="value" id="totalSalesStat">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Pedidos</h3>
                    <div class="value" id="totalOrdersStat">0</div>
                </div>
                <div class="stat-card">
                    <h3>Clientes</h3>
                    <div class="value" id="totalClientsStat">0</div>
                </div>
                <div class="stat-card">
                    <h3>Compra Promedio en Soles  </h3>
                    <div class="value" id="avgTicketStat">$0</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
            
            <h3>üìà Top 15 Mejores Productos</h3>
            <div class="table-responsive">
                <table id="topProductsTable">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad Vendida</th>
                            <th>Total Vendido</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsBody"></tbody>
                </table>
            </div>
            
            <h3>üèÜ Mejores 15 Clientes</h3>
            <div class="table-responsive">
                <table id="topClientsTable">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Pedidos</th>
                            <th>Total Gastado</th>
                        </tr>
                    </thead>
                    <tbody id="topClientsBody"></tbody>
                </table>
            </div>
<!-- Despu√©s de la tabla de Top Clientes por gasto -->
<h3>üèÜ Top 10 Clientes por Frecuencia</h3>
<div class="table-responsive">
    <table id="topFrequentClientsTable">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Veces que compr√≥</th>
                <th>Total Gastado</th>
            </tr>
        </thead>
        <tbody id="topFrequentClientsBody"></tbody>
    </table>
</div>

<h3>üìä Top 10 Productos por Frecuencia</h3>
<div class="table-responsive">
    <table id="topFrequentProductsTable">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Veces vendido</th>
                <th>Total Vendido</th>
            </tr>
        </thead>
        <tbody id="topFrequentProductsBody"></tbody>
    </table>
</div>



        </div>






        
        <!-- Secci√≥n principal (formulario y lista de pedidos) -->
        <div id="mainSection">
            <div class="section">
                <h2>‚ûï Nuevo Pedido</h2>
                <form id="orderForm">
                    <input type="hidden" id="fecha">
                    <input type="hidden" id="editingOrderId" value="">
<div class="grid-2">
    <div class="form-group">
        <label for="fechaPedido">Fecha del Pedido:</label>
        <input type="date" id="fechaPedido" required>
    </div>
</div>                    

                    <div class="autocomplete">
                        <label for="nombre">Cliente:</label>
                        <input type="text" id="nombre" required placeholder="Buscar cliente..." oninput="searchClient(this.value)">
                        <div id="clientAutocompleteList" class="autocomplete-items"></div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="telefono">Tel√©fono:</label>
                            <input type="tel" id="telefono" required>
                        </div>
                        <div class="form-group">
                            <label for="distrito">Distrito:</label>
                            <input type="text" id="distrito" list="distritos" placeholder="Seleccione o ingrese distrito">
                            <datalist id="distritos">
                                <option value="San Miguel">
                                <option value="Jesus Maria">
                                <option value="La Perla">
                                <option value="Magdalena">
                                <option value="Bre√±a">
                                <option value="Cercado">
                                <option value="Bellavista">
				<option value="Lince">
                                <option value="Pueblo Libre">
                                <option value="San Isidro">
                                <option value="Callao">
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="direccion">Direcci√≥n:</label>
                        <input type="text" id="direccion" required>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="formaPago">Forma de Pago:</label>
                            <select id="formaPago">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Yape">Yape</option>
                                <option value="Transferencia">Transferencia</option>
                <option value="Izipay POS">Izipay POS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipoCliente">Tipo de cliente:</label>
                            <select id="tipoCliente">
                                <option value="General">General</option>
                                <option value="Revendedor">Revendedor</option>
                                <option value="Mal Cliente">Mal Cliente</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="horarioEntrega">Horario de Entrega:</label>
                        <select id="horarioEntrega">
                            <option value="">Seleccionar horario</option>
                            <option value="Ma√±ana 10:00 am a 2:00 pm">Ma√±ana 10:00 am a 2:00 pm</option>
                            <option value="Tarde 12:00 pm a 5:00 pm">Tarde 12:00 pm a 5:00 pm</option>
                            <option value="Noche 5:00 pm a 9:00 pm">Noche 5:00 pm a 9:00 pm</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="notas">Notas:</label>
                        <textarea id="notas" rows="2"></textarea>
                    </div>
                    
                    <h3>üõí Productos:</h3>
                    <div class="autocomplete">
                        <input type="text" id="buscarProducto" placeholder="Buscar producto..." oninput="autocompleteProduct(this.value)">
                        <div id="productAutocompleteList" class="autocomplete-items"></div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn-primary" onclick="addProductFromSearch()">Agregar</button>
                        <button type="button" class="btn-warning" onclick="showAddProductModal()">‚ûï Nuevo</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="productTable">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Cant.</th>
                                    <th>Subtotal</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="productBody"></tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3">Total</td>
                                    <td id="totalPedido">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn-primary" onclick="saveOrder()">üíæ Guardar</button>
                        <button type="button" class="btn-warning" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">‚úñ Cancelar</button>
                        <button type="reset" class="btn-danger">‚ôªÔ∏è Limpiar</button>
                    </div>
                </form>
            </div>

            <div class="section">
                <h2>üìã Pedidos Registrados</h2>

<div class="button-group" style="margin-bottom: 15px;">
    <button onclick="filterOrders('today')" class="btn-primary">Hoy</button>
    <button onclick="filterOrders('week')" class="btn-primary">Esta Semana</button>
    <button onclick="filterOrders('month')" class="btn-primary">Este Mes</button>
    <button onclick="filterOrders('all')" class="btn-primary">Todos</button>
    <input type="date" id="filterDate" onchange="filterOrders('custom')" style="max-width: 150px;">
</div>

                <div class="table-responsive">
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th class="mobile-hidden">Cliente</th>
                                <th>Tel√©fono</th>
                                <th>Total</th>
                                <th>Acciones</th>
                <th>Editar Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal para agregar nuevo producto -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('productModal')">&times;</span>
                <h2>‚ûï Nuevo Producto</h2>
                <form id="newProductForm">
                    <div class="form-group">
                        <label for="newProductName">Nombre del Producto:</label>
                        <input type="text" id="newProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="newProductPrice">Precio:</label>
                        <input type="number" id="newProductPrice" min="0" step="0.01" required>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn-primary" onclick="addNewProduct()">Guardar</button>
                        <button type="button" class="btn-danger" onclick="closeModal('productModal')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para importar datos -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('importModal')">&times;</span>
                <h2>üì§ Importar Datos desde Excel</h2>
                <div class="section">
                    <div class="form-group">
                        <label>Tipo de importaci√≥n:</label>
                        <select id="importType" class="form-control">
    <option value="clientes">Clientes</option>
    <option value="productos">Productos</option>
    <option value="pedidos">Pedidos</option> <!-- Nueva opci√≥n -->
</select>
                    </div>
                    
                    <div class="form-group">
                        <label for="excelFile">Seleccionar archivo Excel:</label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls" class="form-control">
                        <small class="text-muted">Formato requerido: XLSX o XLS</small>
                    </div>
                    
                    <div class="button-group">
                        <button id="btnPreview" class="btn-secondary" onclick="previewExcelData()">üëÅÔ∏è Previsualizar</button>
			<button id="btnTemplate" class="btn-secondary" onclick="downloadOrderTemplate()">üìù Descargar Plantilla</button>
                        <button id="btnImport" class="btn-primary" onclick="importExcelData()" disabled>üì• Importar</button>
                    </div>
                    
                    <div id="previewSection" style="margin-top:15px; display:none;">
                        <h4>Vista previa:</h4>
                        <div id="excelPreview" class="table-responsive"></div>
                    </div>
                    
                    <div id="importResults"></div>
                </div>
            </div>
        </div>

        <!-- Modal de Administraci√≥n -->
        <div id="adminModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeModal('adminModal')">&times;</span>
                <h2>Panel de Administraci√≥n</h2>
                
                <div class="grid-2">
                    <div class="section">
                        <h3>üìä Estad√≠sticas</h3>
                        <div id="statsContainer">
                            <p><strong>Clientes:</strong> <span id="clientCount">0</span></p>
                            <p><strong>Productos:</strong> <span id="productCount">0</span></p>
                            <p><strong>Pedidos:</strong> <span id="orderCount">0</span></p>
                            <p><strong>Total Ventas:</strong> $<span id="totalSales">0.00</span></p>
                            <p><strong>√öltima Actualizaci√≥n:</strong> <span id="lastUpdate"></span></p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üíæ Backup/Restauraci√≥n</h3>
                        <div class="form-group">
                            <button class="btn-secondary" onclick="exportBackup()">üì• Exportar Backup</button>
                            <small class="text-muted">Guarda un archivo JSON con todos los datos</small>
                        </div>
                        <div class="form-group">
                            <label for="backupFile">Restaurar desde archivo:</label>
                            <input type="file" id="backupFile" accept=".json">
                            <button class="btn-primary" onclick="importBackup()">üì§ Restaurar Backup</button>
                            <small class="text-muted">Reemplazar√° todos los datos actuales</small>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üßπ Limpieza Selectiva</h3>
                    <div class="form-group">
                        <label>Seleccionar qu√© limpiar:</label>
                        <div class="grid-3">
                            <div>
                                <input type="checkbox" id="clearClients"> <label for="clearClients">Clientes</label>
                            </div>
                            <div>
                                <input type="checkbox" id="clearProducts"> <label for="clearProducts">Productos</label>
                            </div>
                            <div>
                                <input type="checkbox" id="clearOrders"> <label for="clearOrders">Pedidos</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn-danger" onclick="clearSelectedData()">üóëÔ∏è Limpiar Datos Seleccionados</button>
                        <small class="text-muted">¬°Esta acci√≥n no se puede deshacer!</small>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üîç Vista de Datos</h3>
                    <div class="form-group">
                        <select id="dataViewSelector" class="form-control">
                            <option value="clientes">Clientes</option>
                            <option value="productos">Productos</option>
                            <option value="pedidos">Pedidos</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table id="dataViewTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Detalles</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="dataViewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toast notification -->
        <div id="toast" class="toast"></div>

        <script>
            // Configuraci√≥n de IndexedDB
            const DB_NAME = 'PedidosForeverDB';
            const DB_VERSION = 1;
            let db;
            
            // Variables para el gr√°fico
            let salesChart = null;
            let currentPeriod = 'month';
            let currentSpecificDate = null;
            
            // Distritos predefinidos
            const DISTRITOS_PREDEFINIDOS = [
                "San Miguel", "Jesus Maria", "La Perla", 
                "Magdalena", "Bre√±a", "Cercado", "Bellavista",
		"Lince", "Pueblo Libre", "San Isidro", "Callao"
            ];

            // Inicializar IndexedDB
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = function(event) {
                        console.error("Error al abrir la base de datos:", event.target.error);
                        reject("Error al abrir la base de datos");
                    };
                    
                    request.onsuccess = function(event) {
                        db = event.target.result;
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = function(event) {
                        const db = event.target.result;
                        
                        // Crear object stores si no existen
                        if (!db.objectStoreNames.contains('clientes')) {
                            const clientesStore = db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
                            clientesStore.createIndex('nombre', 'nombre', { unique: false });
                            clientesStore.createIndex('telefono', 'telefono', { unique: true });
                        }
                        
                        if (!db.objectStoreNames.contains('productos')) {
                            const productosStore = db.createObjectStore('productos', { keyPath: 'id', autoIncrement: true });
                            productosStore.createIndex('nombre', 'nombre', { unique: true });
                        }
                        
                        if (!db.objectStoreNames.contains('pedidos')) {
                            const pedidosStore = db.createObjectStore('pedidos', { keyPath: 'id', autoIncrement: true });
                            pedidosStore.createIndex('fechaCompleta', 'fechaCompleta', { unique: false });
                            pedidosStore.createIndex('cliente', 'cliente', { unique: false });
                        }
                    };
                });
            }
            
            // Funciones gen√©ricas para operaciones con IndexedDB
            function getAllFromStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                });
            }
            
            function addToStore(storeName, item) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(item);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }
            
            function updateInStore(storeName, item) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(item);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }
            
            function deleteFromStore(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }
            
            function clearStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // ========== FUNCIONES DE AUTOCOMPLETADO ========== //
            
            function searchClient(val) {
    const input = document.getElementById('nombre');
    const container = input.parentNode;
    let lista = container.querySelector('.autocomplete-items');
    
    if (!lista) {
        lista = document.createElement('div');
        lista.className = 'autocomplete-items';
        container.appendChild(lista);
    }
    
    lista.innerHTML = '';
    
    if (!val || val.length < 2) return;
    
    const inputVal = val.toLowerCase();
    
    const transaction = db.transaction(['clientes'], 'readonly');
    const store = transaction.objectStore('clientes');
    const request = store.getAll();
    
    request.onsuccess = function() {
        const clientes = request.result || [];
        const clientesFiltrados = clientes.filter(cliente => 
            cliente.nombre.toLowerCase().includes(inputVal) || 
            (cliente.telefono && cliente.telefono.toString().includes(inputVal))
        ).slice(0, 10); // Limitar a 10 resultados
        
        clientesFiltrados.forEach(cliente => {
            const div = document.createElement('div');
            div.textContent = `${cliente.nombre} - ${cliente.telefono}`;
            div.addEventListener('click', () => {
                input.value = cliente.nombre;
                document.getElementById('telefono').value = cliente.telefono || '';
                document.getElementById('distrito').value = cliente.distrito || '';
                document.getElementById('direccion').value = cliente.direccion || '';
                document.getElementById('formaPago').value = cliente.formaPago || 'Efectivo';
                document.getElementById('tipoCliente').value = cliente.tipo || 'General';
                document.getElementById('horarioEntrega').value = cliente.horarioEntrega || '';
                document.getElementById('notas').value = cliente.notas || '';
                lista.innerHTML = '';
            });
            lista.appendChild(div);
        });
        
        if (clientesFiltrados.length === 0) {
            const div = document.createElement('div');
            div.textContent = "No se encontraron clientes";
            div.style.padding = "8px";
            div.style.color = "#666";
            div.style.fontStyle = "italic";
            lista.appendChild(div);
        }
    };
    
    request.onerror = function(event) {
        console.error("Error al buscar clientes:", event.target.error);
    };
}
            
           function autocompleteProduct(val) {
    const list = document.getElementById("productAutocompleteList");
    list.innerHTML = "";
    
    if (!val || val.length < 2) return;
    
    const inputVal = val.toLowerCase();
    
    const transaction = db.transaction(['productos'], 'readonly');
    const store = transaction.objectStore('productos');
    const request = store.getAll();
    
    request.onsuccess = function() {
        const productos = request.result || [];
        const matches = productos.filter(producto => 
            producto.nombre.toLowerCase().includes(inputVal)
        ).slice(0, 25); // Limitar a 10 resultados
        
        matches.forEach(producto => {
            const item = document.createElement("div");
            item.innerHTML = `<strong>${producto.nombre}</strong> <small>($${producto.precio})</small>`;
            item.addEventListener("click", function() {
                document.getElementById("buscarProducto").value = `${producto.nombre} ($${producto.precio})`;
                list.innerHTML = "";
            });
            list.appendChild(item);
        });
        
        if (matches.length === 0) {
            const item = document.createElement("div");
            item.textContent = "No se encontraron productos";
            item.style.padding = "8px";
            item.style.color = "#666";
            item.style.fontStyle = "italic";
            list.appendChild(item);
        }
    };
    
    request.onerror = function(event) {
        console.error("Error al buscar productos:", event.target.error);
    };
}

            // Cerrar listas de autocompletado al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (e.target.id !== 'nombre' && e.target.id !== 'buscarProducto') {
                    const autocompleteLists = document.querySelectorAll('.autocomplete-items');
                    autocompleteLists.forEach(list => {
                        list.innerHTML = '';
                    });
                }
            });

            // ========== FUNCIONES DEL DASHBOARD ========== //

            function showDashboard() {
                document.getElementById('dashboardSection').style.display = 'block';
                document.getElementById('mainSection').style.display = 'none';
                
                // Inicializar selectores de fecha espec√≠fica
                initDateSelectors();
                updateDashboard(currentPeriod);
            }

            function showMainView() {
                document.getElementById('dashboardSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
                refreshOrdersView();
            }

            function initDateSelectors() {
                // Inicializar selector de a√±os
                const yearSelect = document.getElementById('specificYear');
                yearSelect.innerHTML = '';
                
                const currentYear = new Date().getFullYear();
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                
                // Establecer valores por defecto
                const today = new Date();
                document.getElementById('specificDay').value = today.toISOString().split('T')[0];
                
                const weekNumber = getWeekNumber(today);
                document.getElementById('specificWeek').value = `${today.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
                
                document.getElementById('specificMonth').value = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            }
            
            function getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }

            function updateDashboard(period, specificDate = null) {
    currentPeriod = period;
    currentSpecificDate = specificDate || null;
                
                // Mostrar/ocultar selectores de fecha espec√≠fica
                document.getElementById('dateSelectorContainer').style.display = 'none';
                document.getElementById('daySelector').style.display = 'none';
                document.getElementById('weekSelector').style.display = 'none';
                document.getElementById('monthSelector').style.display = 'none';
                document.getElementById('yearSelector').style.display = 'none';
                
                if (period === 'day') {
                    document.getElementById('dateSelectorContainer').style.display = 'flex';
                    document.getElementById('daySelector').style.display = 'block';
                } else if (period === 'week') {
                    document.getElementById('dateSelectorContainer').style.display = 'flex';
                    document.getElementById('weekSelector').style.display = 'block';
                } else if (period === 'month') {
                    document.getElementById('dateSelectorContainer').style.display = 'flex';
                    document.getElementById('monthSelector').style.display = 'block';
                } else if (period === 'year') {
                    document.getElementById('dateSelectorContainer').style.display = 'flex';
                    document.getElementById('yearSelector').style.display = 'block';
                }
                
               updateSalesChart(period, specificDate);
    updateStats(period, specificDate);
    updateTopProducts();
    updateTopClients();
    updateTopFrequentClients();  // Nueva funci√≥n
    updateTopFrequentProducts(); // Nueva funci√≥n
}
            
            function updateSpecificPeriod(period) {
    currentPeriod = period;
    
    if (period === 'day') {
        const dayInput = document.getElementById('specificDay').value;
        if (dayInput) {
            // Crear la fecha ajustando la zona horaria local
            const [year, month, day] = dayInput.split('-');
            currentSpecificDate = new Date(year, month - 1, day);
            currentSpecificDate.setHours(0, 0, 0, 0);
            
            updateSalesChart(period, currentSpecificDate);
            updateStats(period, currentSpecificDate);
        }
    } else if (period === 'week') {
        const weekInput = document.getElementById('specificWeek').value;
        if (weekInput) {
            const [year, week] = weekInput.split('-W');
            currentSpecificDate = getDateOfWeek(parseInt(week), parseInt(year));
            updateSalesChart(period, currentSpecificDate);
            updateStats(period, currentSpecificDate);
        }
    } else if (period === 'month') {
        const monthInput = document.getElementById('specificMonth').value;
        if (monthInput) {
            const [year, month] = monthInput.split('-');
            currentSpecificDate = new Date(year, parseInt(month) - 1, 1);
            updateSalesChart(period, currentSpecificDate);
            updateStats(period, currentSpecificDate);
        }
    } else if (period === 'year') {
        const yearInput = document.getElementById('specificYear').value;
        if (yearInput) {
            currentSpecificDate = new Date(yearInput, 0, 1);
            updateSalesChart(period, currentSpecificDate);
            updateStats(period, currentSpecificDate);
        }
    }
    
    updateTopProducts();
    updateTopClients();
}
            
            function getDateOfWeek(week, year) {
                const simple = new Date(year, 0, 1 + (week - 1) * 7);
                const dow = simple.getDay();
                const ISOweekStart = simple;
                if (dow <= 4)
                    ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                else
                    ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
                return ISOweekStart;
            }

            function updateSalesChart(period, specificDate = null) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                getSalesDataByPeriod(period, specificDate).then(({ labels, data }) => {
                    if (salesChart) {
                        salesChart.destroy();
                    }
                    
                    salesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ventas por $',
                                data: data,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
            }

            function getSalesDataByPeriod(period, specificDate = null) {
                return new Promise((resolve) => {
                    const now = specificDate || new Date();
                    let labels = [];
                    let data = [];
                    
                    const transaction = db.transaction(['pedidos'], 'readonly');
                    const store = transaction.objectStore('pedidos');
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        const pedidos = request.result || [];
                        
                    if (period === 'day') {
    // Horas del d√≠a espec√≠fico
    labels = [];
    data = Array(24).fill(0);
    
    for (let i = 0; i < 24; i++) {
        labels.push(`${i}:00`);
    }
    
    pedidos.forEach(pedido => {
        const pedidoDate = new Date(pedido.fechaCompleta);
        const pedidoDay = new Date(pedidoDate);
        pedidoDay.setHours(0, 0, 0, 0);
        
        if (pedidoDay.getTime() === now.getTime()) {
            const hour = pedidoDate.getHours();
            data[hour] += parseFloat(pedido.total);
        }
    });
}
                        else if (period === 'week') {
                            // D√≠as de la semana espec√≠fica
                            labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
                            data = Array(7).fill(0);
                            
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); // Lunes
                            
                            for (let i = 0; i < 7; i++) {
                                const day = new Date(startOfWeek);
                                day.setDate(startOfWeek.getDate() + i);
                                
                                pedidos.forEach(pedido => {
                                    const pedidoDate = new Date(pedido.fechaCompleta);
                                    if (pedidoDate.toDateString() === day.toDateString()) {
                                        data[i] += parseFloat(pedido.total);
                                    }
                                });
                            }
                        } 
                        else if (period === 'month') {
                            // Semanas del mes espec√≠fico
                            labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5'];
                            data = [0, 0, 0, 0, 0];
                            
                            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                            const totalDays = lastDay.getDate();
                            
                            pedidos.forEach(pedido => {
                                const pedidoDate = new Date(pedido.fechaCompleta);
                                if (pedidoDate.getMonth() === now.getMonth() && 
                                    pedidoDate.getFullYear() === now.getFullYear()) {
                                    const week = Math.floor((pedidoDate.getDate() + firstDay.getDay() - 1) / 7);
                                    if (week < 5) {
                                        data[week] += parseFloat(pedido.total);
                                    }
                                }
                            });
                        } 
                        else if (period === 'year') {
                            // Meses del a√±o espec√≠fico
                            labels = [];
                            data = Array(12).fill(0);
                            
                            for (let i = 0; i < 12; i++) {
                                const monthName = new Date(now.getFullYear(), i, 1).toLocaleDateString('es-ES', { month: 'short' });
                                labels.push(monthName);
                                
                                pedidos.forEach(pedido => {
                                    const pedidoDate = new Date(pedido.fechaCompleta);
                                    if (pedidoDate.getMonth() === i && 
                                        pedidoDate.getFullYear() === now.getFullYear()) {
                                        data[i] += parseFloat(pedido.total);
                                    }
                                });
                            }
                        } 
                        else {
                            // Todos los datos agrupados por mes
                            const allMonths = {};
                            
                            pedidos.forEach(pedido => {
                                const date = new Date(pedido.fechaCompleta);
                                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                                
                                if (!allMonths[monthYear]) {
                                    allMonths[monthYear] = 0;
                                }
                                allMonths[monthYear] += parseFloat(pedido.total);
                            });
                            
                            labels = Object.keys(allMonths).sort().map(month => {
                                const [year, m] = month.split('-');
                                return new Date(year, m-1).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                            });
                            
                            data = Object.entries(allMonths)
                                .sort((a, b) => a[0].localeCompare(b[0]))
                                .map(([_, total]) => total);
                        }
                        
                        resolve({ labels, data });
                    };
                });
            }

            function updateStats(period, specificDate = null) {
                calculateStats(period, specificDate).then(({ totalSales, totalOrders, avgTicket, uniqueClients }) => {
                    document.getElementById('totalSalesStat').textContent = `$${totalSales.toFixed(2)}`;
                    document.getElementById('totalOrdersStat').textContent = totalOrders;
                    document.getElementById('totalClientsStat').textContent = uniqueClients;
                    document.getElementById('avgTicketStat').textContent = `$${avgTicket.toFixed(2)}`;
                });
            }

            function calculateStats(period, specificDate = null) {
                return new Promise((resolve) => {
                    const now = specificDate || new Date();
                    let filteredOrders = [];
                    
                    const transaction = db.transaction(['pedidos'], 'readonly');
                    const store = transaction.objectStore('pedidos');
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        const allOrders = request.result || [];
                        
                        if (period === 'day') {
    const dayStart = new Date(now);
    dayStart.setHours(0, 0, 0, 0);
    const dayEnd = new Date(dayStart);
    dayEnd.setDate(dayStart.getDate() + 1);
    
    filteredOrders = allOrders.filter(p => {
        const pedidoDate = new Date(p.fechaCompleta);
        return pedidoDate >= dayStart && pedidoDate < dayEnd;
    });
}
                        else if (period === 'week') {
                            const startOfWeek = new Date(now);
                            startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); // Lunes
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            
                            filteredOrders = allOrders.filter(p => {
                                const pedidoDate = new Date(p.fechaCompleta);
                                return pedidoDate >= startOfWeek && pedidoDate <= endOfWeek;
                            });
                        } 
                        else if (period === 'month') {
                            filteredOrders = allOrders.filter(p => {
                                const pedidoDate = new Date(p.fechaCompleta);
                                return pedidoDate.getMonth() === now.getMonth() && 
                                       pedidoDate.getFullYear() === now.getFullYear();
                            });
                        } 
                        else if (period === 'year') {
                            filteredOrders = allOrders.filter(p => {
                                const pedidoDate = new Date(p.fechaCompleta);
                                return pedidoDate.getFullYear() === now.getFullYear();
                            });
                        } 
                        else {
                            filteredOrders = [...allOrders];
                        }
                        
                        const totalSales = filteredOrders.reduce((sum, p) => sum + parseFloat(p.total), 0);
                        const totalOrders = filteredOrders.length;
                        const avgTicket = totalOrders > 0 ? totalSales / totalOrders : 0;
                        
                        const uniqueClients = new Set(filteredOrders.map(p => p.cliente)).size;
                        
                        resolve({ totalSales, totalOrders, avgTicket, uniqueClients });
                    };
                });
            }

            function updateTopProducts() {
                const productSales = {};
                
                const transaction = db.transaction(['pedidos'], 'readonly');
                const store = transaction.objectStore('pedidos');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const pedidos = request.result || [];
                    
                    // Filtrar por per√≠odo si es necesario
                    let filteredPedidos = pedidos;
                    if (currentSpecificDate) {
                        const now = currentSpecificDate;
                        filteredPedidos = pedidos.filter(p => {
                            const pedidoDate = new Date(p.fechaCompleta);
                            
                            if (currentPeriod === 'day') {
                                return pedidoDate.getDate() === now.getDate() && 
                                       pedidoDate.getMonth() === now.getMonth() && 
                                       pedidoDate.getFullYear() === now.getFullYear();
                            } else if (currentPeriod === 'week') {
                                const startOfWeek = new Date(now);
                                startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                                const endOfWeek = new Date(startOfWeek);
                                endOfWeek.setDate(startOfWeek.getDate() + 6);
                                return pedidoDate >= startOfWeek && pedidoDate <= endOfWeek;
                            } else if (currentPeriod === 'month') {
                                return pedidoDate.getMonth() === now.getMonth() && 
                                       pedidoDate.getFullYear() === now.getFullYear();
                            } else if (currentPeriod === 'year') {
                                return pedidoDate.getFullYear() === now.getFullYear();
                            }
                            return true;
                        });
                    }
                    
                    filteredPedidos.forEach(pedido => {
                        pedido.productos.forEach(producto => {
                            if (!productSales[producto.producto]) {
                                productSales[producto.producto] = {
                                    quantity: 0,
                                    total: 0
                                };
                            }
                            productSales[producto.producto].quantity += producto.cantidad;
                            productSales[producto.producto].total += producto.subtotal;
                        });
                    });
                    
                    const sortedProducts = Object.entries(productSales)
                        .sort((a, b) => b[1].total - a[1].total)
                        .slice(0, 15);
                    
                    const tbody = document.getElementById('topProductsBody');
                    tbody.innerHTML = '';
                    
                    sortedProducts.forEach(([name, stats]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${name}</td>
                            <td>${stats.quantity}</td>
                            <td>$${stats.total.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            }

            function updateTopClients() {
                const clientStats = {};
                
                const transaction = db.transaction(['pedidos'], 'readonly');
                const store = transaction.objectStore('pedidos');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const pedidos = request.result || [];
                    
                    // Filtrar por per√≠odo si es necesario
                    let filteredPedidos = pedidos;
                    if (currentSpecificDate) {
                        const now = currentSpecificDate;
                        filteredPedidos = pedidos.filter(p => {
                            const pedidoDate = new Date(p.fechaCompleta);
                            
                            if (currentPeriod === 'day') {
                                return pedidoDate.getDate() === now.getDate() && 
                                       pedidoDate.getMonth() === now.getMonth() && 
                                       pedidoDate.getFullYear() === now.getFullYear();
                            } else if (currentPeriod === 'week') {
                                const startOfWeek = new Date(now);
                                startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                                const endOfWeek = new Date(startOfWeek);
                                endOfWeek.setDate(startOfWeek.getDate() + 6);
                                return pedidoDate >= startOfWeek && pedidoDate <= endOfWeek;
                            } else if (currentPeriod === 'month') {
                                return pedidoDate.getMonth() === now.getMonth() && 
                                       pedidoDate.getFullYear() === now.getFullYear();
                            } else if (currentPeriod === 'year') {
                                return pedidoDate.getFullYear() === now.getFullYear();
                            }
                            return true;
                        });
                    }
                    
                    filteredPedidos.forEach(pedido => {
                        if (!clientStats[pedido.cliente]) {
                            clientStats[pedido.cliente] = {
                                count: 0,
                                total: 0
                            };
                        }
                        
                        clientStats[pedido.cliente].count++;
                        clientStats[pedido.cliente].total += parseFloat(pedido.total);
                    });
                    
                    const sortedClients = Object.entries(clientStats)
                        .sort((a, b) => b[1].total - a[1].total)
                        .slice(0, 15);
                    
                    const tbody = document.getElementById('topClientsBody');
                    tbody.innerHTML = '';
                    
                    sortedClients.forEach(([name, stats]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${name}</td>
                            <td>${stats.count}</td>
                            <td>$${stats.total.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            }

function updateTopFrequentClients() {
    const clientStats = {};
    
    const transaction = db.transaction(['pedidos'], 'readonly');
    const store = transaction.objectStore('pedidos');
    const request = store.getAll();
    
    request.onsuccess = function() {
        const pedidos = request.result || [];
        
        // Filtrar por per√≠odo si es necesario
        let filteredPedidos = pedidos;
        if (currentSpecificDate) {
            const now = currentSpecificDate;
            filteredPedidos = pedidos.filter(p => {
                const pedidoDate = new Date(p.fechaCompleta);
                
                if (currentPeriod === 'day') {
                    return pedidoDate.getDate() === now.getDate() && 
                           pedidoDate.getMonth() === now.getMonth() && 
                           pedidoDate.getFullYear() === now.getFullYear();
                } else if (currentPeriod === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    return pedidoDate >= startOfWeek && pedidoDate <= endOfWeek;
                } else if (currentPeriod === 'month') {
                    return pedidoDate.getMonth() === now.getMonth() && 
                           pedidoDate.getFullYear() === now.getFullYear();
                } else if (currentPeriod === 'year') {
                    return pedidoDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }
        
        // Contar frecuencia de compra
        filteredPedidos.forEach(pedido => {
            if (!clientStats[pedido.cliente]) {
                clientStats[pedido.cliente] = {
                    count: 0,
                    total: 0
                };
            }
            
            clientStats[pedido.cliente].count++;
            clientStats[pedido.cliente].total += parseFloat(pedido.total);
        });
        
        // Ordenar por frecuencia (count) y limitar a 10
        const sortedClients = Object.entries(clientStats)
            .sort((a, b) => b[1].count - a[1].count)
            .slice(0, 10);
        
        const tbody = document.getElementById('topFrequentClientsBody');
        tbody.innerHTML = '';
        
        sortedClients.forEach(([name, stats]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${name}</td>
                <td>${stats.count}</td>
                <td>$${stats.total.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
    };
}

function updateTopFrequentProducts() {
    const productStats = {};
    
    const transaction = db.transaction(['pedidos'], 'readonly');
    const store = transaction.objectStore('pedidos');
    const request = store.getAll();
    
    request.onsuccess = function() {
        const pedidos = request.result || [];
        
        // Filtrar por per√≠odo si es necesario
        let filteredPedidos = pedidos;
        if (currentSpecificDate) {
            const now = currentSpecificDate;
            filteredPedidos = pedidos.filter(p => {
                const pedidoDate = new Date(p.fechaCompleta);
                
                if (currentPeriod === 'day') {
                    return pedidoDate.getDate() === now.getDate() && 
                           pedidoDate.getMonth() === now.getMonth() && 
                           pedidoDate.getFullYear() === now.getFullYear();
                } else if (currentPeriod === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    return pedidoDate >= startOfWeek && pedidoDate <= endOfWeek;
                } else if (currentPeriod === 'month') {
                    return pedidoDate.getMonth() === now.getMonth() && 
                           pedidoDate.getFullYear() === now.getFullYear();
                } else if (currentPeriod === 'year') {
                    return pedidoDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }
        
        // Contar frecuencia de venta por producto
        filteredPedidos.forEach(pedido => {
            pedido.productos.forEach(producto => {
                if (!productStats[producto.producto]) {
                    productStats[producto.producto] = {
                        count: 0,
                        total: 0
                    };
                }
                
                // Contar cada vez que aparece en un pedido (no la cantidad)
                productStats[producto.producto].count++;
                productStats[producto.producto].total += producto.subtotal;
            });
        });
        
        // Ordenar por frecuencia (count) y limitar a 10
        const sortedProducts = Object.entries(productStats)
            .sort((a, b) => b[1].count - a[1].count)
            .slice(0, 10);
        
        const tbody = document.getElementById('topFrequentProductsBody');
        tbody.innerHTML = '';
        
        sortedProducts.forEach(([name, stats]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${name}</td>
                <td>${stats.count}</td>
                <td>$${stats.total.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
    };
}






            // ========== FUNCIONES DE IMPORTACI√ìN/EXPORTACI√ìN ========== //

            function openImportModal() {
                document.getElementById('importModal').style.display = 'block';
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('btnImport').disabled = true;
                document.getElementById('importResults').innerHTML = '';
                document.getElementById('excelFile').value = '';
            }

            function previewExcelData() {
                const file = document.getElementById('excelFile').files[0];
                const importType = document.getElementById('importType').value;
                
                if (!file) {
                    showToast("‚ö†Ô∏è Por favor seleccione un archivo", 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Mostrar vista previa
                    let html = `<table class="table-bordered" style="width:100%"><thead><tr>`;
                    
                    // Cabeceras
                    if (jsonData.length > 0) {
                        Object.keys(jsonData[0]).forEach(key => {
                            html += `<th>${key}</th>`;
                        });
                        html += `</tr></thead><tbody>`;
                        
                        // Primeras 5 filas
                        jsonData.slice(0, 5).forEach(row => {
                            html += `<tr>`;
                            Object.values(row).forEach(val => {
                                html += `<td>${val || ''}</td>`;
                            });
                            html += `</tr>`;
                        });
                    }
                    
                    html += `</tbody></table>`;
                    html += `<p>Mostrando ${Math.min(5, jsonData.length)} de ${jsonData.length} registros</p>`;
                    
                    document.getElementById('excelPreview').innerHTML = html;
                    document.getElementById('previewSection').style.display = 'block';
                    document.getElementById('btnImport').disabled = false;
                };
                reader.readAsArrayBuffer(file);
            }

          function importExcelData() {
    const file = document.getElementById('excelFile').files[0];
    const importType = document.getElementById('importType').value;
    
    if (!file) {
        showToast("‚ö†Ô∏è Por favor seleccione un archivo", 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
            
            let successCount = 0;
            let errorCount = 0;
            let errorMessages = [];

            if (importType === 'pedidos') {
                // Obtener el √∫ltimo ID de pedido para generar nuevos IDs
                getAllFromStore('pedidos').then(existingOrders => {
                    const maxId = existingOrders.length > 0 ? 
                        Math.max(...existingOrders.map(p => p.id)) + 1 : 1;
                    
                    const importPromises = jsonData.map((item, index) => {
                        return new Promise((resolve, reject) => {
                            try {
                                // Validaciones b√°sicas
                                if (!item['CLIENTE'] && !item['Cliente']) {
                                    throw new Error("Falta nombre del cliente");
                                }
                                
                                if (!item['PRODUCTOS'] && !item['Productos']) {
                                    throw new Error("Falta lista de productos");
                                }

                                const nuevoId = maxId + index;
                                const cliente = (item['CLIENTE'] || item['Cliente'] || "").toString().trim();
                                const telefono = (item['TELEFONO'] || item['Tel√©fono'] || "").toString().trim();
                                const direccion = (item['DIRECCION'] || item['Direcci√≥n'] || "").toString().trim();
                                const distrito = (item['DISTRITO'] || item['Distrito'] || "").toString().trim();
                                const formaPago = (item['FORMA DE PAGO'] || item['Forma de Pago'] || "Efectivo").toString().trim();
                                const tipoCliente = (item['TIPO'] || item['Tipo'] || "General").toString().trim();
                                const horarioEntrega = (item['HORARIO ENTREGA'] || item['Horario Entrega'] || "").toString().trim();
                                const notas = (item['NOTAS'] || item['Notas'] || "").toString().trim();
                                
                                // Procesar productos (con manejo de espacios)
                                const productosStr = (item['PRODUCTOS'] || item['Productos'] || "").toString().trim();
                                const productos = [];
                                let total = 0;
                                
                                productosStr.split(',').forEach(itemProd => {
                                    const match = itemProd.trim().match(/(.*?)\s*\(\s*([\d.]+)\s*\)\s*x\s*(\d+)/);
                                    if (match) {
                                        const producto = match[1].trim();
                                        const precio = parseFloat(match[2].trim());
                                        const cantidad = parseInt(match[3].trim());
                                        const subtotal = precio * cantidad;
                                        
                                        productos.push({
                                            producto,
                                            precio,
                                            cantidad,
                                            subtotal
                                        });
                                        total += subtotal;
                                    }
                                });
                                
                                // Manejo de fechas m√°s robusto
                                let fecha = item['FECHA'] || item['Fecha'];
                                let fechaCompleta;
                                
                                if (fecha) {
                                    try {
                                        if (typeof fecha === 'number') {
                                            // Fecha como n√∫mero de Excel
                                            const date = XLSX.SSF.parse_date_code(fecha);
                                            fechaCompleta = new Date(date.y, date.m - 1, date.d);
                                        } else {
                                            // Intentar parsear como fecha
                                            fechaCompleta = new Date(fecha);
                                            if (isNaN(fechaCompleta.getTime())) {
                                                // Si falla, intentar formato dd/mm/yyyy
                                                const parts = fecha.toString().split('/');
                                                if (parts.length === 3) {
                                                    fechaCompleta = new Date(parts[2], parts[1] - 1, parts[0]);
                                                }
                                            }
                                        }
                                        
                                        if (isNaN(fechaCompleta.getTime())) {
                                            throw new Error("Fecha inv√°lida");
                                        }
                                    } catch (e) {
                                        console.warn("Fecha inv√°lida, usando fecha actual:", e);
                                        fechaCompleta = new Date();
                                    }
                                } else {
                                    fechaCompleta = new Date();
                                }
                                
                                // Formatear fecha legible
                                const fechaFormateada = fechaCompleta.toLocaleDateString('es-ES', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                }).replace(/\//g, '-');
                                
                                // Crear el pedido
                                const nuevoPedido = {
                                    id: nuevoId,
                                    cliente,
                                    telefono,
                                    direccion,
                                    distrito,
                                    formaPago,
                                    tipoCliente,
                                    horarioEntrega,
                                    notas,
                                    productos,
                                    total: total.toFixed(2),
                                    fecha: fechaFormateada,
                                    fechaCompleta: fechaCompleta.toISOString()
                                };
                                
                                // Guardar el pedido en IndexedDB
                                addToStore('pedidos', nuevoPedido)
                                    .then(() => {
                                        // Actualizar o crear cliente
                                        return updateOrCreateClient(
                                            cliente, 
                                            telefono, 
                                            direccion, 
                                            distrito, 
                                            formaPago, 
                                            tipoCliente, 
                                            horarioEntrega, 
                                            notas
                                        );
                                    })
                                    .then(() => {
                                        successCount++;
                                        resolve();
                                    })
                                    .catch(error => {
                                        errorCount++;
                                        errorMessages.push(`Fila ${index + 2}: ${error.message}`);
                                        console.error(`Error al importar pedido (fila ${index + 2}):`, error);
                                        reject(error);
                                    });
                            } catch (e) {
                                errorCount++;
                                errorMessages.push(`Fila ${index + 2}: ${e.message}`);
                                console.error(`Error al importar pedido (fila ${index + 2}):`, e);
                                reject(e);
                            }
                        });
                    });

                    Promise.all(importPromises)
                        .then(() => {
                            // Mostrar resultados
                            let resultHTML = `<div class="alert alert-success">
                                ‚úÖ Importaci√≥n completada: ${successCount} registros importados</div>`;
                            
                            if (errorCount > 0) {
                                resultHTML += `<div class="alert alert-danger">
                                    ‚ùå ${errorCount} errores:<br>${errorMessages.join('<br>')}</div>`;
                            }
                            
                            document.getElementById('importResults').innerHTML = resultHTML;
                            
                            // Actualizar vistas
                            refreshOrdersView();
                            updateDashboard(currentPeriod);
                        })
                        .catch(error => {
                            console.error("Error en la importaci√≥n:", error);
                        });
                });
            } else {
                // Resto del c√≥digo para otros tipos de importaci√≥n...
            }
        } catch (error) {
            console.error("Error general al importar:", error);
            document.getElementById('importResults').innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå Error al procesar el archivo: ${error.message}
                </div>`;
        }
    };
    
    reader.onerror = function() {
        document.getElementById('importResults').innerHTML = `
            <div class="alert alert-danger">
                ‚ùå Error al leer el archivo
            </div>`;
    };
    
    reader.readAsArrayBuffer(file);
}

function downloadOrderTemplate() {
    const templateData = [
        ["Cliente", "Tel√©fono", "Direcci√≥n", "Distrito", "Forma de Pago", "Tipo", "Horario", "Notas", "Productos", "Fecha"],
        ["Juan P√©rez", "987654321", "Av. Ejemplo 123", "San Miguel", "Efectivo", "General", "Tarde 12:00 pm a 5:00 pm", "Llamar antes de llegar", "Producto1 x 2, Producto2 x 1", "01-01-2023"],
        ["Mar√≠a G√≥mez", "912345678", "Calle Muestra 456", "Jesus Maria", "Yape", "Revendedor", "Ma√±ana 10:00 am a 2:00 pm", "", "Producto3 x 3", "02-01-2023"]
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    XLSX.utils.book_append_sheet(wb, ws, "PlantillaPedidos");
    XLSX.writeFile(wb, "Plantilla_Pedidos_Forever.xlsx");
}


            function generateExcel() {
                getAllFromStore('pedidos').then(pedidos => {
                    if (pedidos.length === 0) {
                        showToast("‚ö†Ô∏è No hay pedidos registrados", 'error');
                        return;
                    }

                    const wb = XLSX.utils.book_new();
                    
                    // Hoja de resumen
                    const summaryData = [
                        ["Resumen de Pedidos"],
                        [],
                        ["ID", "Fecha", "Cliente", "Tel√©fono", "Distrito", "Forma de Pago", "Horario Entrega", "Total", "Tipo"]
                    ];

                    pedidos.forEach(pedido => {
                        summaryData.push([
                            pedido.id,
                            pedido.fecha,
                            pedido.cliente,
                            pedido.telefono,
                            pedido.distrito || '',
                            pedido.formaPago || '',
                            pedido.horarioEntrega || '',
                            pedido.total,
                            pedido.tipoCliente
                        ]);
                    });

                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");

                    // Hojas por pedido
                    pedidos.forEach(pedido => {
                        const clientData = [
                            ["Detalles del Pedido"],
                            ["ID:", pedido.id],
                            ["Fecha:", pedido.fecha],
                            ["Cliente:", pedido.cliente],
                            ["Tel√©fono:", pedido.telefono],
                            ["Distrito:", pedido.distrito || ''],
                            ["Direcci√≥n:", pedido.direccion],
                            ["Forma de Pago:", pedido.formaPago || ''],
                            ["Horario Entrega:", pedido.horarioEntrega || ''],
                            ["Tipo:", pedido.tipoCliente],
                            ["Notas:", pedido.notas || ''],
                            [],
                            ["Productos", "Precio Unitario", "Cantidad", "Subtotal"]
                        ];

                        pedido.productos.forEach(p => {
                            clientData.push([p.producto, p.precio, p.cantidad, p.subtotal]);
                        });

                        clientData.push([], ["Total:", "", "", pedido.total]);

                        const wsClient = XLSX.utils.aoa_to_sheet(clientData);
                        XLSX.utils.book_append_sheet(wb, wsClient, `Pedido ${pedido.id}`);
                    });

                    XLSX.writeFile(wb, `Pedidos_${new Date().toISOString().split('T')[0]}.xlsx`);
                    showToast("‚úÖ Archivo Excel generado correctamente", 'success');
                });
            }

            // ========== FUNCIONES DEL PANEL ADMINISTRATIVO ========== //

            function showAdminModal() {
                updateAdminStats();
                loadDataView();
                document.getElementById('adminModal').style.display = 'block';
            }
            
            function updateAdminStats() {
                Promise.all([
                    getAllFromStore('clientes'),
                    getAllFromStore('productos'),
                    getAllFromStore('pedidos')
                ]).then(([clientes, productos, pedidos]) => {
                    document.getElementById('clientCount').textContent = clientes.length;
                    document.getElementById('productCount').textContent = productos.length;
                    document.getElementById('orderCount').textContent = pedidos.length;
                    
                    const totalSales = pedidos.reduce((sum, pedido) => sum + parseFloat(pedido.total), 0);
                    document.getElementById('totalSales').textContent = totalSales.toFixed(2);
                    
                    updateLastModified();
                });
            }
            
            function loadDataView() {
                const type = document.getElementById('dataViewSelector').value;
                const tbody = document.getElementById('dataViewBody');
                tbody.innerHTML = '';
                
                getAllFromStore(type).then(data => {
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        
                        // Columna ID
                        const idCell = document.createElement('td');
                        idCell.textContent = item.id;
                        row.appendChild(idCell);
                        
                        // Columna Detalles
                        const detailsCell = document.createElement('td');
                        detailsCell.style.maxWidth = '300px';
                        detailsCell.style.overflow = 'hidden';
                        detailsCell.style.textOverflow = 'ellipsis';
                        detailsCell.style.whiteSpace = 'nowrap';
                        
                        if (type === 'clientes') {
                            detailsCell.textContent = `${item.nombre} - ${item.telefono}`;
                            detailsCell.title = `Direcci√≥n: ${item.direccion}\nDistrito: ${item.distrito || 'N/A'}\nNotas: ${item.notas || 'Ninguna'}`;
                        } else if (type === 'productos') {
                            detailsCell.textContent = `${item.nombre} - $${item.precio}`;
                        } else if (type === 'pedidos') {
                            detailsCell.textContent = `${item.fecha} - ${item.cliente} - $${item.total}`;
                            detailsCell.title = `Productos: ${item.productos.length}\nTel: ${item.telefono}\nDirecci√≥n: ${item.direccion}`;
                        }
                        
                        row.appendChild(detailsCell);
                        
                        // Columna Acciones
                        const actionsCell = document.createElement('td');
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn-danger';
                        deleteBtn.textContent = '‚ùå';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteItem(type, item.id);
                        };
                        actionsCell.appendChild(deleteBtn);
                        row.appendChild(actionsCell);
                        
                        tbody.appendChild(row);
                    });
                });
            }
            
            function deleteItem(type, id) {
                if (!confirm(`¬øEst√° seguro de eliminar este ${type.slice(0, -1)}?`)) {
                    return;
                }
                
                deleteFromStore(type, id)
                    .then(() => {
                        updateAdminStats();
                        loadDataView();
                        refreshOrdersView();
                        showToast(`‚úÖ ${type === 'clientes' ? 'Cliente' : type === 'productos' ? 'Producto' : 'Pedido'} eliminado`, 'success');
                    })
                    .catch(error => {
                        console.error("Error al eliminar:", error);
                        showToast("‚ö†Ô∏è Error al eliminar", 'error');
                    });
            }
            
            function exportBackup() {
                Promise.all([
                    getAllFromStore('clientes'),
                    getAllFromStore('productos'),
                    getAllFromStore('pedidos')
                ]).then(([clientes, productos, pedidos]) => {
                    const backupData = {
                        clientes,
                        productos,
                        pedidos,
                        fechaBackup: new Date().toISOString(),
                        versionSistema: '2.0'
                    };
                    
                    const dataStr = JSON.stringify(backupData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportName = `backup_pedidos_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportName);
                    linkElement.click();
                    
                    showToast("‚úÖ Backup exportado correctamente", 'success');
                });
            }
            
            function importBackup() {
                const fileInput = document.getElementById('backupFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast("‚ö†Ô∏è Seleccione un archivo de backup", 'error');
                    return;
                }
                
                if (!confirm("¬øEst√° seguro de restaurar este backup? Todos los datos actuales ser√°n reemplazados.")) {
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validaci√≥n b√°sica del backup
                        if (!backupData.clientes || !backupData.productos || !backupData.pedidos) {
                            throw new Error("Formato de backup inv√°lido");
                        }
                        
                        // Limpiar las bases de datos existentes
                        Promise.all([
                            clearStore('clientes'),
                            clearStore('productos'),
                            clearStore('pedidos')
                        ]).then(() => {
                            // Importar los nuevos datos
                            const clientPromises = backupData.clientes.map(c => addToStore('clientes', c));
                            const productPromises = backupData.productos.map(p => addToStore('productos', p));
                            const orderPromises = backupData.pedidos.map(o => addToStore('pedidos', o));
                            
                            return Promise.all([
                                Promise.all(clientPromises),
                                Promise.all(productPromises),
                                Promise.all(orderPromises)
                            ]);
                        }).then(() => {
                            refreshOrdersView();
                            updateAdminStats();
                            loadDataView();
                            showToast("‚úÖ Backup restaurado correctamente", 'success');
                        }).catch(error => {
                            console.error("Error al importar backup:", error);
                            showToast("‚ö†Ô∏è Error al importar backup: " + error.message, 'error');
                        });
                    } catch (error) {
                        console.error("Error al importar backup:", error);
                        showToast("‚ö†Ô∏è Error al importar backup: " + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
            
            function clearSelectedData() {
                const clearClients = document.getElementById('clearClients').checked;
                const clearProducts = document.getElementById('clearProducts').checked;
                const clearOrders = document.getElementById('clearOrders').checked;
                
                if (!clearClients && !clearProducts && !clearOrders) {
                    showToast("‚ö†Ô∏è Seleccione al menos un tipo de dato para limpiar", 'error');
                    return;
                }
                
                if (!confirm("¬øEST√Å SEGURO? Esta acci√≥n eliminar√° permanentemente los datos seleccionados.")) {
                    return;
                }
                
                const promises = [];
                if (clearClients) promises.push(clearStore('clientes'));
                if (clearProducts) promises.push(clearStore('productos'));
                if (clearOrders) promises.push(clearStore('pedidos'));
                
                Promise.all(promises)
                    .then(() => {
                        refreshOrdersView();
                        updateAdminStats();
                        loadDataView();
                        showToast("‚úÖ Datos limpiados correctamente", 'success');
                    })
                    .catch(error => {
                        console.error("Error al limpiar datos:", error);
                        showToast("‚ö†Ô∏è Error al limpiar datos", 'error');
                    });
            }

            // ========== FUNCIONES B√ÅSICAS DEL SISTEMA ========== //

            function saveOrder() {
                // Validar campos del cliente
                const nombre = document.getElementById('nombre').value.trim();
                const telefono = document.getElementById('telefono').value.trim();
                const direccion = document.getElementById('direccion').value.trim();
   
const fechaPedidoInput = document.getElementById('fechaPedido').value;
    let fechaPedido;
    
    if (fechaPedidoInput) {
        fechaPedido = new Date(fechaPedidoInput);
    } else {
        fechaPedido = new Date(); // Usar fecha actual si no se especifica
    }

const fechaFormateada = fechaPedido.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\//g, '-');

    const nuevoPedido = {
        // ... (otros campos existentes)
        fecha: fechaFormateada,
        fechaCompleta: fechaPedido.toISOString()
    }
             
                if (!nombre) {
                    showToast("‚ö†Ô∏è Por favor ingrese el nombre del cliente", 'error');
                    document.getElementById('nombre').focus();
                    return;
                }
                
                if (!telefono) {
                    showToast("‚ö†Ô∏è Por favor ingrese el tel√©fono del cliente", 'error');
                    document.getElementById('telefono').focus();
                    return;
                }
                
                if (!direccion) {
                    showToast("‚ö†Ô∏è Por favor ingrese la direcci√≥n del cliente", 'error');
                    document.getElementById('direccion').focus();
                    return;
                }

                // 1. PRIMERO ACTUALIZAMOS O CREAMOS EL CLIENTE
                const distrito = document.getElementById('distrito').value.trim();
                const formaPago = document.getElementById('formaPago').value;
                const tipoCliente = document.getElementById('tipoCliente').value;
                const horarioEntrega = document.getElementById('horarioEntrega').value;
                const notas = document.getElementById('notas').value.trim();
                
                updateOrCreateClient(nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas)
                    .then(() => {
                        // 2. LUEGO PROCESAMOS EL PEDIDO
                        const productos = [];
                        let total = 0;
                        let hasErrors = false;
                        
                        document.querySelectorAll('#productBody tr').forEach(row => {
                            const producto = row.querySelector('.producto').value.trim();
                            const precioInput = row.querySelector('.precio');
                            const cantidadInput = row.querySelector('.cantidad');
                            
                            const precio = parseFloat(precioInput.value) || 0;
                            const cantidad = parseInt(cantidadInput.value) || 0;
                            const subtotal = precio * cantidad;
                            
                            if (!producto) {
                                showToast("‚ö†Ô∏è Todos los productos deben tener un nombre", 'error');
                                row.querySelector('.producto').focus();
                                hasErrors = true;
                                return;
                            }
                            
                            if (precio <= 0) {
                                showToast("‚ö†Ô∏è El precio debe ser mayor que 0", 'error');
                                precioInput.focus();
                                hasErrors = true;
                                return;
                            }
                            
                            if (cantidad <= 0) {
                                showToast("‚ö†Ô∏è La cantidad debe ser mayor que 0", 'error');
                                cantidadInput.focus();
                                hasErrors = true;
                                return;
                            }
                            
                            productos.push({
                                producto,
                                precio,
                                cantidad,
                                subtotal
                            });
                            total += subtotal;
                        });
                        
                        if (hasErrors) return;
                        
                        if (productos.length === 0) {
                            showToast("‚ö†Ô∏è Debe agregar al menos un producto al pedido", 'error');
                            return;
                        }

                        // Verificar si estamos editando un pedido existente
                        const editingOrderId = document.getElementById('editingOrderId').value;
                        
                        if (editingOrderId) {
                            // Actualizar pedido existente
                            updateOrder(editingOrderId, nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas, productos, total);
                        } else {
                            // Crear nuevo pedido
                            createNewOrder(nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas, productos, total);
                        }
                    })
                    .catch(error => {
                        console.error("Error al guardar cliente:", error);
                        showToast("‚ö†Ô∏è Error al guardar cliente", 'error');
                    });
            }

            function updateOrder(id, nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas, productos, total) {
                const transaction = db.transaction(['pedidos'], 'readwrite');
                const store = transaction.objectStore('pedidos');
                const getRequest = store.get(parseInt(id));
                
                getRequest.onsuccess = function() {
                    const pedido = getRequest.result;
                    if (!pedido) {
                        showToast("‚ö†Ô∏è Pedido no encontrado", 'error');
                        return;
                    }
                    
                    const updatedPedido = {
                        ...pedido,
                        cliente: nombre,
                        telefono,
                        direccion,
                        distrito,
                        formaPago,
                        tipoCliente,
                        horarioEntrega,
                        notas,
                        productos,
                        total: total.toFixed(2),
                        fechaCompleta: new Date().toISOString()
                    };
                    
                    const updateRequest = store.put(updatedPedido);
                    
                    updateRequest.onsuccess = function() {
                        document.getElementById('orderForm').reset();
                        document.getElementById('productBody').innerHTML = '';
                        document.getElementById('totalPedido').textContent = "0.00";
                        document.getElementById('editingOrderId').value = '';
                        document.getElementById('cancelEditBtn').style.display = 'none';
                        
                        // Actualizar dashboard si est√° visible
                        if (document.getElementById('dashboardSection').style.display === 'block') {
                            updateDashboard(currentPeriod);
                        }
                        
                        refreshOrdersView();
                        showToast(`‚úÖ Pedido #${id} actualizado correctamente`, 'success');
                    };
                    
                    updateRequest.onerror = function(event) {
                        console.error("Error al actualizar pedido:", event.target.error);
                        showToast("‚ö†Ô∏è Error al actualizar pedido", 'error');
                    };
                };
                
                getRequest.onerror = function(event) {
                    console.error("Error al obtener pedido:", event.target.error);
                    showToast("‚ö†Ô∏è Error al obtener pedido", 'error');
                };
            }

            function createNewOrder(nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas, productos, total) {
                // Obtener la fecha del pedido
    const fechaPedidoInput = document.getElementById('fechaPedido').value;
    let fechaPedido;
    
    if (fechaPedidoInput) {
        fechaPedido = new Date(fechaPedidoInput);
    } else {
        fechaPedido = new Date(); // Usar fecha actual si no se especifica
    }

    const nuevoPedido = {
        cliente: nombre,
        telefono,
        direccion,
        distrito,
        formaPago,
        tipoCliente,
        horarioEntrega,
        notas,
        productos,
        total: total.toFixed(2),
        fecha: fechaPedido.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }).replace(/\//g, '-'),
        fechaCompleta: fechaPedido.toISOString()
    }

   

                addToStore('pedidos', nuevoPedido)
                    .then(id => {
                        // Actualizar vista y limpiar formulario
                        document.getElementById('orderForm').reset();
                        document.getElementById('productBody').innerHTML = '';
                        document.getElementById('totalPedido').textContent = "0.00";
                        
                        // Actualizar dashboard si est√° visible
                        if (document.getElementById('dashboardSection').style.display === 'block') {
                            updateDashboard(currentPeriod);
                        }
                        
                        refreshOrdersView();
                        showToast(`‚úÖ Pedido #${id} para ${nombre} guardado correctamente`, 'success');
                    })
                    .catch(error => {
                        console.error("Error al guardar pedido:", error);
                        showToast("‚ö†Ô∏è Error al guardar pedido", 'error');
                    });
            }

            function editOrder(pedidoId) {
                const transaction = db.transaction(['pedidos'], 'readonly');
                const store = transaction.objectStore('pedidos');
                const request = store.get(parseInt(pedidoId));
                
                request.onsuccess = function() {
                    const pedido = request.result;
                    if (!pedido) {
                        showToast("‚ö†Ô∏è Pedido no encontrado", 'error');
                        return;
                    }

                    // Llenar el formulario con los datos del pedido
                    document.getElementById('nombre').value = pedido.cliente;
                    document.getElementById('telefono').value = pedido.telefono;
                    document.getElementById('distrito').value = pedido.distrito || '';
                    document.getElementById('direccion').value = pedido.direccion;
                    document.getElementById('formaPago').value = pedido.formaPago || 'Efectivo';
                    document.getElementById('tipoCliente').value = pedido.tipoCliente || 'General';
                    document.getElementById('horarioEntrega').value = pedido.horarioEntrega || '';
                    document.getElementById('notas').value = pedido.notas || '';
                    document.getElementById('editingOrderId').value = pedido.id;
                    
                    // Limpiar la tabla de productos
                    const productBody = document.getElementById('productBody');
                    productBody.innerHTML = '';
                    
                    // Agregar los productos del pedido
                    pedido.productos.forEach(producto => {
                        addProductRow(producto.producto, producto.precio, producto.cantidad);
                    });
                    
                    // Actualizar el total
                    document.getElementById('totalPedido').textContent = pedido.total;
                    
                    // Mostrar bot√≥n de cancelar edici√≥n
                    document.getElementById('cancelEditBtn').style.display = 'inline-block';
                    
                    // Desplazarse al formulario
                    document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
                    
                    showToast(`‚úèÔ∏è Editando pedido #${pedidoId}`, 'info');
                };
                
                request.onerror = function(event) {
                    console.error("Error al obtener pedido:", event.target.error);
                    showToast("‚ö†Ô∏è Error al obtener pedido", 'error');
                };
            }

            function cancelEdit() {
                document.getElementById('orderForm').reset();
                document.getElementById('productBody').innerHTML = '';
                document.getElementById('totalPedido').textContent = "0.00";
                document.getElementById('editingOrderId').value = '';
                document.getElementById('cancelEditBtn').style.display = 'none';
document.getElementById('fechaPedido').value = '';
                showToast("‚úñ Edici√≥n cancelada", 'info');
            }

            function updateOrCreateClient(nombre, telefono, direccion, distrito, formaPago, tipoCliente, horarioEntrega, notas) {
                return new Promise((resolve, reject) => {
                    // Buscar cliente por tel√©fono (√∫nico)
                    const transaction = db.transaction(['clientes'], 'readwrite');
                    const store = transaction.objectStore('clientes');
                    const index = store.index('telefono');
                    const request = index.get(telefono);
                    
                    request.onsuccess = function() {
                        const clienteExistente = request.result;
                        
                        if (clienteExistente) {
                            // Actualizar datos del cliente existente
                            clienteExistente.nombre = nombre;
                            clienteExistente.telefono = telefono;
                            clienteExistente.direccion = direccion;
                            clienteExistente.distrito = distrito || clienteExistente.distrito;
                            clienteExistente.formaPago = formaPago || clienteExistente.formaPago;
                            clienteExistente.tipo = tipoCliente || clienteExistente.tipo;
                            clienteExistente.horarioEntrega = horarioEntrega || clienteExistente.horarioEntrega;
                            clienteExistente.notas = notas || clienteExistente.notas;
                            
                            const updateRequest = store.put(clienteExistente);
                            
                            updateRequest.onsuccess = function() {
                                showToast(`‚úÖ Cliente "${nombre}" actualizado`, 'success');
                                resolve(clienteExistente.id);
                            };
                            
                            updateRequest.onerror = function(event) {
                                console.error("Error al actualizar cliente:", event.target.error);
                                reject("Error al actualizar cliente");
                            };
                        } else {
                            // Crear nuevo cliente
                            const nuevoCliente = {
                                nombre,
                                telefono,
                                direccion,
                                distrito: distrito || '',
                                formaPago: formaPago || 'Efectivo',
                                tipo: tipoCliente || 'General',
                                horarioEntrega: horarioEntrega || '',
                                notas: notas || ''
                            };
                            
                            const addRequest = store.add(nuevoCliente);
                            
                            addRequest.onsuccess = function(event) {
                                showToast(`‚úÖ Cliente "${nombre}" agregado`, 'success');
                                resolve(event.target.result);
                            };
                            
                            addRequest.onerror = function(event) {
                                console.error("Error al agregar cliente:", event.target.error);
                                reject("Error al agregar cliente");
                            };
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error("Error al buscar cliente:", event.target.error);
                        reject("Error al buscar cliente");
                    };
                });
            }

            function addProductFromSearch() {
                const input = document.getElementById('buscarProducto').value;
                const match = input.match(/(.*) \(\$(.*)\)/);
                
                if (match) {
                    const producto = match[1].trim();
                    const precio = parseFloat(match[2]);
                    addProductRow(producto, precio);
                    document.getElementById('buscarProducto').value = '';
                } else if (input.trim() !== "") {
                    // Buscar si el producto ya existe en la base de datos
                    const transaction = db.transaction(['productos'], 'readonly');
                    const store = transaction.objectStore('productos');
                    const index = store.index('nombre');
                    const request = index.get(input);
                    
                    request.onsuccess = function() {
                        const productoExistente = request.result;
                        
                        if (productoExistente) {
                            addProductRow(productoExistente.nombre, productoExistente.precio);
                            document.getElementById('buscarProducto').value = '';
                        } else {
                            const nuevoPrecio = prompt(`Ingrese el precio para "${input}":`);
                            if (nuevoPrecio && !isNaN(nuevoPrecio)) {
                                // Crear nuevo producto en la base de datos
                                const nuevoProducto = {
                                    nombre: input,
                                    precio: parseFloat(nuevoPrecio)
                                };
                                
                                addToStore('productos', nuevoProducto)
                                    .then(() => {
                                        addProductRow(input, parseFloat(nuevoPrecio));
                                        document.getElementById('buscarProducto').value = '';
                                        showToast(`‚úÖ Producto "${input}" agregado a la base de datos`, 'success');
                                    })
                                    .catch(error => {
                                        console.error("Error al agregar producto:", error);
                                        showToast("‚ö†Ô∏è Error al agregar producto", 'error');
                                    });
                            }
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error("Error al buscar producto:", event.target.error);
                        showToast("‚ö†Ô∏è Error al buscar producto", 'error');
                    };
                }
            }

            function showAddProductModal() {
                document.getElementById('productModal').style.display = 'block';
                document.getElementById('newProductName').value = document.getElementById('buscarProducto').value || '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductName').focus();
            }

            function addNewProduct() {
                const nombre = document.getElementById('newProductName').value.trim();
                const precio = parseFloat(document.getElementById('newProductPrice').value);
                
                if (nombre && !isNaN(precio)) {
                    const nuevoProducto = {
                        nombre,
                        precio
                    };
                    
                    addToStore('productos', nuevoProducto)
                        .then(() => {
                            closeModal('productModal');
                            addProductRow(nombre, precio);
                            document.getElementById('buscarProducto').value = `${nombre} ($${precio})`;
                            showToast(`‚úÖ Producto "${nombre}" agregado correctamente`, 'success');
                        })
                        .catch(error => {
                            console.error("Error al agregar producto:", error);
                            showToast("‚ö†Ô∏è Error al agregar producto", 'error');
                        });
                } else {
                    showToast("‚ö†Ô∏è Ingrese un nombre y precio v√°lidos", 'error');
                }
            }

            function addProductRow(producto = "", precio = 0, cantidad = 1) {
                const tbody = document.getElementById('productBody');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="producto" value="${producto}" required></td>
                    <td><input type="number" class="precio" value="${precio}" min="0" step="0.01" required onchange="updateSubtotal(this)"></td>
                    <td><input type="number" class="cantidad" min="1" value="${cantidad}" required onchange="updateSubtotal(this)"></td>
                    <td class="subtotal">${(precio * cantidad).toFixed(2)}</td>
                    <td><button type="button" class="btn-danger" onclick="this.closest('tr').remove(); updateTotal();">‚ùå</button></td>
                `;
                tbody.appendChild(row);
                updateTotal();
            }

            function updateSubtotal(input) {
                const row = input.closest('tr');
                const precio = parseFloat(row.querySelector('.precio').value) || 0;
                const cantidad = parseInt(row.querySelector('.cantidad').value) || 0;
                row.querySelector('.subtotal').textContent = (precio * cantidad).toFixed(2);
                updateTotal();
            }

            function updateTotal() {
                let total = 0;
                document.querySelectorAll('.subtotal').forEach(cell => {
                    total += parseFloat(cell.textContent) || 0;
                });
                document.getElementById('totalPedido').textContent = total.toFixed(2);
            }

            
                function refreshOrdersView() {
    const tbody = document.getElementById('ordersBody');
    tbody.innerHTML = '';

    getAllFromStore('pedidos').then(pedidos => {
        // Ordenar por fecha (m√°s reciente primero)
        const pedidosOrdenados = [...pedidos].sort((a, b) => 
            new Date(b.fechaCompleta) - new Date(a.fechaCompleta));
        
        let currentDateGroup = '';
        
        pedidosOrdenados.forEach(pedido => {
            const pedidoDate = new Date(pedido.fechaCompleta);
            const dateGroup = pedidoDate.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).replace(/\b\w/g, l => l.toUpperCase());
            
            // Agregar separador de fecha si cambi√≥
            if (dateGroup !== currentDateGroup) {
                currentDateGroup = dateGroup;
                const dateRow = document.createElement('tr');
                dateRow.className = 'date-group-header';
                dateRow.innerHTML = `
                    <td colspan="6" style="
                        background-color: #f0f0f0;
                        font-weight: bold;
                        padding: 10px;
                        font-size: 1.1em;
                    ">
                        üìÖ ${dateGroup}
                    </td>
                `;
                tbody.appendChild(dateRow);
            }
            
            // Fila del pedido
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${pedido.fecha}</td>
                <td class="mobile-hidden">${pedido.cliente}</td>
                <td>${pedido.telefono}</td>
                <td>$${pedido.total}</td>
                <td>
                    <button class="btn-primary" onclick="viewOrderDetails(${pedido.id})">üëÅÔ∏è</button>
                    <button class="btn-secondary" onclick="editOrder(${pedido.id})">‚úèÔ∏è</button>
                    <button class="btn-danger" onclick="deleteOrder(${pedido.id})">‚ùå</button>
                </td>
                <td>
                    <button class="btn-warning" onclick="editOrderDate(${pedido.id})">üìÖ</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    });
}
            

            function viewOrderDetails(pedidoId) {
                const transaction = db.transaction(['pedidos'], 'readonly');
                const store = transaction.objectStore('pedidos');
                const request = store.get(parseInt(pedidoId));
                
                request.onsuccess = function() {
                    const pedido = request.result;
                    if (!pedido) {
                        showToast("‚ö†Ô∏è Pedido no encontrado", 'error');
                        return;
                    }

                    let detalles = `üìÖ Fecha: ${pedido.fecha}\n`;
                    detalles += `üë§ Cliente: ${pedido.cliente}\n`;
                    detalles += `üìû Tel√©fono: ${pedido.telefono}\n`;
                    if (pedido.distrito) detalles += `üìç Distrito: ${pedido.distrito}\n`;
                    detalles += `üí≥ Forma de Pago: ${pedido.formaPago}\n`;
                    detalles += `‚è∞ Horario de Entrega: ${pedido.horarioEntrega}\n`;
                    detalles += `üè† Direcci√≥n: ${pedido.direccion}\n`;
                    detalles += `üè∑Ô∏è Tipo: ${pedido.tipoCliente}\n`;
                    if (pedido.notas) detalles += `üìù Notas: ${pedido.notas}\n\n`;
                    detalles += `üõí Productos:\n`;
                    
                    pedido.productos.forEach(p => {
                        detalles += `- ${p.producto}: $${p.precio} x ${p.cantidad} = $${p.subtotal}\n`;
                    });
                    
                    detalles += `\nüíµ Total: S/.${pedido.total}`;

                    const modalContent = `
                        <div class="modal-content" style="max-width: 600px;">
                            <span class="close" onclick="closeModal('detailsModal')">&times;</span>
                            <h2>Detalles del Pedido #${pedido.id}</h2>
                            <div class="section" style="white-space: pre-line; margin-bottom: 20px;">${detalles}</div>
                            <div class="button-group">
                                <button class="btn-secondary" onclick="copyToClipboard(\`${detalles.replace(/`/g, '\\`')}\`)">üìã Copiar</button>
                                <button class="btn-primary" onclick="closeModal('detailsModal')">Cerrar</button>
                            </div>
                        </div>
                    `;
                    
                    showCustomModal(modalContent, 'detailsModal');
                };
                
                request.onerror = function(event) {
                    console.error("Error al obtener pedido:", event.target.error);
                    showToast("‚ö†Ô∏è Error al obtener pedido", 'error');
                };
            }

            function deleteOrder(pedidoId) {
                if (confirm("¬øEst√° seguro de eliminar este pedido?")) {
                    deleteFromStore('pedidos', parseInt(pedidoId))
                        .then(() => {
                            refreshOrdersView();
                            
                            // Actualizar dashboard si est√° visible
                            if (document.getElementById('dashboardSection').style.display === 'block') {
                                updateDashboard(currentPeriod);
                            }
                            
                            showToast("‚úÖ Pedido eliminado correctamente", 'success');
                        })
                        .catch(error => {
                            console.error("Error al eliminar pedido:", error);
                            showToast("‚ö†Ô∏è Error al eliminar pedido", 'error');
                        });
                }
            }

            function resetDatabase() {
                if (confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esto borrar√° TODOS los clientes, productos y pedidos de forma permanente.")) {
                    Promise.all([
                        clearStore('clientes'),
                        clearStore('productos'),
                        clearStore('pedidos')
                    ]).then(() => {
                        // Actualizar la vista
                        refreshOrdersView();
                        document.getElementById('productBody').innerHTML = '';
                        document.getElementById('totalPedido').textContent = "0.00";
                        
                        // Actualizar dashboard si est√° visible
                        if (document.getElementById('dashboardSection').style.display === 'block') {
                            updateDashboard(currentPeriod);
                        }
                        
                        showToast("‚úÖ Base de datos reiniciada completamente", 'success');
                    }).catch(error => {
                        console.error("Error al reiniciar base de datos:", error);
                        showToast("‚ö†Ô∏è Error al reiniciar base de datos", 'error');
                    });
                }
            }

            // ========== FUNCIONES AUXILIARES ========== //

            function updateLastModified() {
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleString();
            }

            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.style.display = 'block';
                toast.style.backgroundColor = type === 'error' ? 'var(--danger-color)' : 
                                             type === 'success' ? 'var(--primary-color)' : '#333';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            function showCustomModal(content, modalId = 'customModal') {
                let modal = document.getElementById(modalId);
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                }
                modal.innerHTML = content;
                modal.style.display = 'block';
            }

            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text)
                            .then(() => showToast("‚úÖ Copiado al portapapeles", 'success'))
                            .catch(() => fallbackCopy(textarea));
                    } else {
                        fallbackCopy(textarea);
                    }
                } catch (err) {
                    console.error("Error al copiar:", err);
                    showToast("‚ö†Ô∏è Seleccione el texto y copie manualmente", 'error');
                } finally {
                    document.body.removeChild(textarea);
                }
            }

function editOrderDate(pedidoId) {
    const transaction = db.transaction(['pedidos'], 'readwrite');
    const store = transaction.objectStore('pedidos');
    const request = store.get(parseInt(pedidoId));
    
    request.onsuccess = function() {
        const pedido = request.result;
        if (!pedido) {
            showToast("‚ö†Ô∏è Pedido no encontrado", 'error');
            return;
        }

        // Convertir la fecha almacenada al formato de input date (YYYY-MM-DD)
        const fechaCompleta = new Date(pedido.fechaCompleta);
        const fechaInput = fechaCompleta.toISOString().split('T')[0];
        document.getElementById('fechaPedido').value = fechaInput;

        const nuevaFecha = prompt("Ingrese la nueva fecha (Formato: DD-MM-AAAA):", pedido.fecha);
        
        if (nuevaFecha && nuevaFecha !== pedido.fecha) {
            // Validar formato de fecha
            if (!/^\d{2}-\d{2}-\d{4}$/.test(nuevaFecha)) {
                showToast("‚ö†Ô∏è Formato de fecha inv√°lido. Use DD-MM-AAAA", 'error');
                return;
            }

            // Actualizar ambas representaciones de fecha
            const [day, month, year] = nuevaFecha.split('-');
            pedido.fecha = nuevaFecha;
            pedido.fechaCompleta = new Date(year, month-1, day).toISOString();
            
            const updateRequest = store.put(pedido);
            
            updateRequest.onsuccess = function() {
                refreshOrdersView();
                if (document.getElementById('dashboardSection').style.display === 'block') {
                    updateDashboard(currentPeriod);
                }
                showToast("‚úÖ Fecha actualizada correctamente", 'success');
            };
            
            updateRequest.onerror = function(event) {
                console.error("Error al actualizar fecha:", event.target.error);
                showToast("‚ö†Ô∏è Error al actualizar fecha", 'error');
            };
        }
    };
    
    request.onerror = function(event) {
        console.error("Error al obtener pedido:", event.target.error);
        showToast("‚ö†Ô∏è Error al obtener pedido", 'error');
    };
}
function filterOrders(range) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const filterDate = document.getElementById('filterDate');
    
    getAllFromStore('pedidos').then(pedidos => {
        let filtered = pedidos;
        
        switch(range) {
            case 'today':
                filtered = pedidos.filter(p => {
                    const pedidoDate = new Date(p.fechaCompleta);
                    return pedidoDate >= today;
                });
                break;
                
            case 'week':
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                filtered = pedidos.filter(p => {
                    const pedidoDate = new Date(p.fechaCompleta);
                    return pedidoDate >= startOfWeek;
                });
                break;
                
            case 'month':
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                filtered = pedidos.filter(p => {
                    const pedidoDate = new Date(p.fechaCompleta);
                    return pedidoDate >= startOfMonth;
                });
                break;
                
            case 'custom':
                const customDate = new Date(filterDate.value);
                if (isNaN(customDate.getTime())) return;
                
                const nextDay = new Date(customDate);
                nextDay.setDate(customDate.getDate() + 1);
                
                filtered = pedidos.filter(p => {
                    const pedidoDate = new Date(p.fechaCompleta);
                    return pedidoDate >= customDate && pedidoDate < nextDay;
                });
                break;
        }
        
        // Mostrar resultados filtrados
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';
        
        let currentDateGroup = '';
        
        filtered.sort((a, b) => new Date(b.fechaCompleta) - new Date(a.fechaCompleta))
            .forEach(pedido => {
                const pedidoDate = new Date(pedido.fechaCompleta);
                const dateGroup = pedidoDate.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).replace(/\b\w/g, l => l.toUpperCase());
                
                if (dateGroup !== currentDateGroup) {
                    currentDateGroup = dateGroup;
                    const dateRow = document.createElement('tr');
                    dateRow.className = 'date-group-header';
                    dateRow.innerHTML = `
                        <td colspan="6" style="
                            background-color: #f0f0f0;
                            font-weight: bold;
                            padding: 10px;
                            font-size: 1.1em;
                        ">
                            üìÖ ${dateGroup}
                        </td>
                    `;
                    tbody.appendChild(dateRow);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pedido.fecha}</td>
                    <td class="mobile-hidden">${pedido.cliente}</td>
                    <td>${pedido.telefono}</td>
                    <td>$${pedido.total}</td>
                    <td>
                        <button class="btn-primary" onclick="viewOrderDetails(${pedido.id})">üëÅÔ∏è</button>
                        <button class="btn-secondary" onclick="editOrder(${pedido.id})">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteOrder(${pedido.id})">‚ùå</button>
                    </td>
                    <td>
                        <button class="btn-warning" onclick="editOrderDate(${pedido.id})">üìÖ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
    });
}


            function fallbackCopy(textarea) {
                try {
                    const successful = document.execCommand('copy');
                    if (!successful) throw new Error('Fall√≥ execCommand');
                    showToast("‚úÖ Copiado al portapapeles", 'success');
                } catch (err) {
                    console.error("Error con execCommand:", err);
                    showToast("‚ö†Ô∏è Pulse Ctrl+C para copiar", 'error');
                    textarea.select();
                }
            }

            // Inicializaci√≥n
            document.addEventListener('DOMContentLoaded', function() {
                initDB().then(() => {
                    refreshOrdersView();
                     document.getElementById('fechaPedido').value = new Date().toISOString().split('T')[0];
                    
                    // Configurar evento para el selector de datos
                    document.getElementById('dataViewSelector').addEventListener('change', loadDataView);
                    
                    // Agregar un producto de ejemplo si no hay productos
                    getAllFromStore('productos').then(productos => {
                        if (productos.length === 0) {
                            addProductRow("Laptop", 12000);
                        }
                    });
                }).catch(error => {
                    console.error("Error al inicializar la base de datos:", error);
                    showToast("‚ö†Ô∏è Error al inicializar la base de datos", 'error');
                });
            });

            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            };
        </script>
    </div>
</body>
</html>
